{% extends "layout.html" %}

{% block subtitle %}Dashboard{% endblock %}

{% block body %}

    <style>
        .custom_error_icon .webix_icon {
            color: red !important;
        }
    </style>

    <script>

        /*==============================================================================================================
         ======================================== Validators
         =============================================================================================================*/

        const basic_validators = {
            isEmpty: function (value) {
                if (value === undefined) {
                    return true;
                } else if (/^\s*$/.test(value)) {
                    return true;
                }
                return false;
            },
        };
        const property_validators = {
            form: {
                $name: function (value) {
                    let valid_regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;
                    if (basic_validators.isEmpty(value)) {
                        return false;
                    } else if (!valid_regex.test(value)) {
                        return false;
                    }
                    return true;
                },
            },
            datablock: {
                $name: function (value) {
                    let valid_regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;
                    if (basic_validators.isEmpty(value)) {
                        return false;
                    } else if (!valid_regex.test(value)) {
                        return false;
                    }
                    return true;
                },
                $type: function (value) {
                    let allowed_values = ["form", "tabular"];
                    if (basic_validators.isEmpty(value)) {
                        return false;
                    } else if (!allowed_values.includes(value)) {
                        return false;
                    }
                    return true;
                },
            },
            item: {
                $name: function (value) {
                    let valid_regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;
                    if (basic_validators.isEmpty(value)) {
                        return false;
                    } else if (!valid_regex.test(value)) {
                        return false;
                    }
                    return true;
                },
                $label: function (value) {
                    let valid_regex = /^.*$/;
                    if (basic_validators.isEmpty(value)) {
                        return false;
                    } else if (!valid_regex.test(value)) {
                        return false;
                    }
                    return true;
                },
                $type: function (value) {
                    let allowed_values = ["text", "numeric", "date", "datetime", "currency", "checkbox"];
                    if (basic_validators.isEmpty(value)) {
                        return false;
                    } else if (!allowed_values.includes(value)) {
                        return false;
                    }
                    return true;
                },
            },
        };

        /*==============================================================================================================
         ======================================== Functions
         =============================================================================================================*/

        let validate_item = function (item, validators) {
            for (let validator_key in validators) {
                let validate_property = validators[validator_key];
                let property_value = item[validator_key];
                if (validate_property(property_value) === false)
                    return false;
            }
            return true;
        };

        let tree_folder_callback = function (item) {
            let icon_class = "webix_icon mdi ";
            switch (item.$$kind) {
                case "form":
                    icon_class += "mdi-application-cog-outline";
                    return `<span class="${icon_class}"></span>`;
                case "datablock":
                    icon_class += "mdi-database-cog-outline";
                    return `<span class="${icon_class}"></span>`;
                case "item":
                    icon_class += "mdi-form-textbox";
                    return `<span class="${icon_class}"></span>`;
            }
        };

        let tree_template_callback = function (item, common) {
            let icon_common_1 = common.icon(item, common);
            let icon_common_2 = common.folder(item, common);
            let icon_common_2_error = `<span class="custom_error_icon">${common.folder(item, common)}</span>`;
            if (item.$name === undefined)
                item.$name = "";
            switch (item.$$kind) {
                case "form":
                    if (validate_item(item, property_validators.form))
                        return `${icon_common_1} ${icon_common_2} ${item.$name}`;
                    return `${icon_common_1} ${icon_common_2_error} ${item.$name}`;
                case "datablock":
                    if (validate_item(item, property_validators.datablock))
                        return `${icon_common_1} ${icon_common_2} ${item.$name}`;
                    return `${icon_common_1} ${icon_common_2_error} ${item.$name}`;
                case "item":
                    if (validate_item(item, property_validators.item))
                        return `${icon_common_1} ${icon_common_2} ${item.$name}`;
                    return `${icon_common_1} ${icon_common_2_error} ${item.$name}`;
            }
        };

        /*==============================================================================================================
         ======================================== View Factory
         =============================================================================================================*/

        webix.ui({
            type: "space",
            cols: [
                {
                    type: "wide", width: 250, minWidth: 250, maxWidth: 450,
                    rows: [
                        {
                            id: "tree", view: "tree", select: true, minHeight: 175, data: [],
                            type: {folder: tree_folder_callback}, template: tree_template_callback,
                        },
                        {view: "resizer"},
                        {
                            minHeight: 175,
                            rows: [
                                {
                                    id: "property-form", view: "property", hidden: true,
                                    elements: [
                                        {type: "label", label: "General"},
                                        {label: "#", id: "id"},
                                        {type: "text", label: "name", id: "$name"},
                                    ],
                                },
                                {
                                    id: "property-datablock", view: "property", hidden: true,
                                    elements: [
                                        {type: "label", label: "General"},
                                        {label: "#", id: "id"},
                                        {type: "text", label: "name", id: "$name"},
                                        {
                                            type: "combo", label: "type", id: "$type", options: [
                                                {id: "form", value: "Form"},
                                                {id: "tabular", value: "Tabular"},
                                            ],
                                        },
                                    ],
                                },
                                {
                                    id: "property-item", view: "property", hidden: true,
                                    elements: [
                                        {type: "label", label: "General"},
                                        {label: "#", id: "id"},
                                        {type: "text", label: "name", id: "$name"},
                                        {type: "text", label: "label", id: "$label"},
                                        {
                                            type: "combo", label: "type", id: "$type", options: [
                                                {id: "text", value: "Text"},
                                                {id: "numeric", value: "Numeric"},
                                                {id: "date", value: "Date"},
                                                {id: "datetime", value: "Date Time"},
                                                {id: "currency", value: "Currency"},
                                                {id: "checkbox", value: "Checkbox"},
                                            ],
                                        },
                                    ],
                                },
                            ],
                        },
                    ],
                },
                {view: "resizer"},
                {
                    id: "content", rows: [],
                },
            ],
        });

        /*==============================================================================================================
         ======================================== View Selector
         =============================================================================================================*/

        const tree = $$("tree");
        const property_form = $$("property-form");
        const property_datablock = $$("property-datablock");
        const property_item = $$("property-item");
        const content = $$("content");
        const context_menu_form = webix.ui({
            view: "contextmenu", width: 200,
            data: [
                {
                    id: "insert", value: "Insert", data: [
                        {id: "insert-datablock", value: "Data Block"},
                    ],
                },
                {$template: "Separator"},
                {id: "triggers", value: "Triggers"},
            ],
        });
        const context_menu_datablock = webix.ui({
            view: "contextmenu", width: 200,
            data: [
                {
                    id: "insert", value: "Insert", data: [
                        {id: "insert-item", value: "Item"},
                    ],
                },
                {id: "delete", value: "Delete"},
                {$template: "Separator"},
                {id: "triggers", value: "Triggers"},
            ],
        });
        const context_menu_item = webix.ui({
            view: "contextmenu", width: 200,
            data: [
                {id: "delete", value: "Delete"},
                {$template: "Separator"},
                {id: "triggers", value: "Triggers"},
            ],
        });

        /*==============================================================================================================
         ======================================== View Binding
         =============================================================================================================*/

        context_menu_form.attachTo(tree);
        context_menu_datablock.attachTo(tree);
        context_menu_item.attachTo(tree);

        /*==============================================================================================================
         ======================================== Tree Event
         =============================================================================================================*/

        tree.attachEvent("onBeforeContextMenu", function (id) {
            let item = tree.getItem(id);
            tree.select(item.id);
        });

        tree.attachEvent("onBeforeSelect", function () {
            property_form.hide();
            property_datablock.hide();
            property_item.hide();
        });

        tree.attachEvent("onAfterSelect", function (id) {
            let item = tree.getItem(id);
            switch (item.$$kind) {
                case "form":
                    property_form.clear();
                    property_form.setValues(item);
                    property_form.show();
                    break;
                case "datablock":
                    property_datablock.clear();
                    property_datablock.setValues(item);
                    property_datablock.show();
                    break;
                case "item":
                    property_item.clear();
                    property_item.setValues(item);
                    property_item.show();
                    break;
            }
        });

        /*==============================================================================================================
         ======================================== Context Menu Event
         =============================================================================================================*/

        context_menu_form.attachEvent("onBeforeShow", function () {
            let item = tree.getSelectedItem();
            return item.$$kind === "form";
        });

        context_menu_datablock.attachEvent("onBeforeShow", function () {
            let item = tree.getSelectedItem();
            return item.$$kind === "datablock";
        });

        context_menu_item.attachEvent("onBeforeShow", function () {
            let item = tree.getSelectedItem();
            return item.$$kind === "item";
        });

        context_menu_form.attachEvent("onMenuItemClick", function (id) {
            let item = tree.getSelectedItem();
            switch (id) {
                case "insert-datablock":
                    let new_item = {$$kind: "datablock"};
                    let new_item_id = tree.add(new_item, -1, item.id);
                    tree.open(item.id);
                    tree.select(new_item_id);
                    break;
                case "triggers":
                    webix.message(`"${item.value}" triggers`);
                    break;
            }
        });

        context_menu_datablock.attachEvent("onMenuItemClick", function (id) {
            let item = tree.getSelectedItem();
            switch (id) {
                case "insert-item":
                    let new_item = {$$kind: "item"};
                    let new_item_id = tree.add(new_item, -1, item.id);
                    tree.open(item.id);
                    tree.select(new_item_id);
                    break;
                case "delete":
                    webix.confirm({
                        title: "Warning!",
                        type: "confirm-warning",
                        text: "You are about to delete this Data Block. Are you sure?",
                        ok: "Delete",
                    }).then(function () {
                        tree.remove(item.id);
                        property_form.hide();
                        property_datablock.hide();
                        property_item.hide();
                        tree.select(item.$parent);
                    });
                    break;
                case "triggers":
                    webix.message(`"${item.value}" triggers`);
                    break;
            }
        });

        context_menu_item.attachEvent("onMenuItemClick", function (id) {
            let item = tree.getSelectedItem();
            switch (id) {
                case "delete":
                    webix.confirm({
                        title: "Warning!",
                        type: "confirm-warning",
                        text: "You are about to delete this Item. Are you sure?",
                        ok: "Delete",
                    }).then(function () {
                        tree.remove(item.id);
                        property_form.hide();
                        property_datablock.hide();
                        property_item.hide();
                        tree.select(item.$parent);
                    });
                    break;
                case "triggers":
                    webix.message(`"${item.value}" triggers`);
                    break;
            }
        });

        /*==============================================================================================================
         ======================================== Property Event
         =============================================================================================================*/

        property_form.attachEvent("onAfterEditStart", function () {
            tree.disable();
        });

        property_datablock.attachEvent("onAfterEditStart", function () {
            tree.disable();
        });

        property_item.attachEvent("onAfterEditStart", function () {
            tree.disable();
        });

        property_form.attachEvent("onAfterEditStop", function () {
            let form_values = property_form.getValues();
            tree.updateItem(form_values.id, form_values);
            tree.enable();
        });

        property_datablock.attachEvent("onAfterEditStop", function () {
            let form_values = property_datablock.getValues();
            tree.updateItem(form_values.id, form_values);
            tree.enable();
        });

        property_item.attachEvent("onAfterEditStop", function () {
            let form_values = property_item.getValues();
            tree.updateItem(form_values.id, form_values);
            tree.enable();
        });

        /*==============================================================================================================
         ======================================== View Constructor
         =============================================================================================================*/

        let item_id = tree.add({$$kind: "form"});
        let content_id = content.addView({
            view: "scrollview", scroll: "xy", body: {},
        });

        tree.open(item_id);
        tree.select(item_id);

    </script>

{% endblock %}